<html lang="en" style="padding: 20px">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="shortcut icon" type="image/png" href="images/favicon.png" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.9.3/semantic.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/v/se/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-colvis-3.0.2/b-html5-3.0.2/b-print-3.0.2/cr-2.0.2/date-1.5.2/fc-5.0.0/fh-4.0.1/kt-2.12.0/r-3.0.2/rg-1.5.0/sc-2.4.2/sb-1.7.1/sp-2.3.1/datatables.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fomantic-ui/2.9.3/semantic.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/v/se/jszip-3.10.1/dt-2.0.7/b-3.0.2/b-colvis-3.0.2/b-html5-3.0.2/b-print-3.0.2/cr-2.0.2/date-1.5.2/fc-5.0.0/fh-4.0.1/kt-2.12.0/r-3.0.2/rg-1.5.0/sc-2.4.2/sb-1.7.1/sp-2.3.1/datatables.min.js"></script>
    <script type="text/javascript" src="script/cfg-tables.js"></script>
    <script type="text/javascript" src="30.Flows.js"></script>
    <script type="text/javascript" src="31.FlowBestPractices.js"></script>
    <style>
      .matrix-table th:not(.flow-type) {
        text-align: left;
        height: auto !important;
        padding: 14px !important;
        vertical-align: bottom !important;
      }
      .matrix-table th.flow-type {
        position: relative;
        padding: 0 !important;
        vertical-align: bottom;
        text-align: left;
        /* Height will be set dynamically by JS */
      }
      .matrix-table th.flow-type > div {
        position: absolute;
        left: calc(50% + 6px); /* 6px is half of typical padding */
        bottom: 12px;
        transform-origin: bottom left;
        transform: rotate(-90deg);
        white-space: nowrap;
        text-align: left;
        width: max-content;
      }
    </style>
    <script>
      // Dynamically set header row height to fit the tallest rotated label
      function adjustMatrixHeaderHeight() {
        document.querySelectorAll(".matrix-table").forEach(function (table) {
          const headerRow = table.querySelector("thead tr");
          if (!headerRow) return;
          let maxLabelLength = 0;
          table.querySelectorAll("th.flow-type > div").forEach(function (div) {
            // Temporarily reset height to auto for measurement
            div.parentElement.style.height = "auto";
            // Get the rotated label's width (which is the height needed)
            const labelLength = div.offsetWidth;
            if (labelLength > maxLabelLength) maxLabelLength = labelLength;
          });
          if (maxLabelLength > 0) {
            // Add a little extra for padding
            headerRow.style.height = maxLabelLength + 16 + "px";
          }
        });
      }
      // Run on DOMContentLoaded and after table redraws
      document.addEventListener("DOMContentLoaded", adjustMatrixHeaderHeight);
      // If using DataTables or dynamic content, re-run after redraw
      if (window.jQuery) {
        jQuery(document).on("draw.dt", adjustMatrixHeaderHeight);
      }
    </script>
    <title>Flows – Best Practices</title>
  </head>
  <body>
    <h2 class="ui header">Flows – Best Practices</h2>

    <!-- Matrix Tables -->
    <h3 class="ui header">Best Practice Violations – All Flows</h3>
    <div id="violation-matrix-all-container"></div>

    <h3 class="ui header">Best Practice Violations – Active Flows Only</h3>
    <div id="violation-matrix-active-container"></div>

    <h3 class="ui header">Violation Details by Flow</h3>
    <table id="best-practices" class="ui responsive celled table">
      <thead>
        <tr class="header">
          <th>Flow</th>
          <th>Violated Rule</th>
          <th>Details</th>
          <th>Severity</th>
        </tr>
      </thead>
    </table>
    <script>
      function renderFlowCount(
        detailTableId,
        typeIndex,
        statusIndex,
        statusValue
      ) {
        return function (data, type, row, meta) {
          if (type !== "display" || !row || !row.type || data === 0)
            return data;

          const name = row.type;
          const safeName = String(name).replace(/"/g, "&quot;");
          const secondFilter =
            (
              typeof statusIndex === "number" &&
              typeof statusValue === "string" &&
              statusValue.length > 0
            ) ?
              `setColumnFilter('${detailTableId}', ${statusIndex}, '${statusValue}');`
            : "";
          return `<a href="#" onclick="
        clearAllFilters('${detailTableId}');
        setColumnFilter('${detailTableId}', ${typeIndex}, '/^${safeName}$');
        ${secondFilter}
        scrollTableIntoView('${detailTableId}');
        return false;
      ">${data}</a>`;
        };
      }

      function renderLabelAndFullName(data, type, row, meta) {
        if (type !== "display")
          return data?.label + " (" + data?.fullName + ")";

        const fullName = data.fullName;
        const label = data.label;
        // Escape for HTML
        const safeFullName = String(fullName).replace(/"/g, "&quot;");
        const safeLabel = String(label).replace(/"/g, "&quot;");
        return `<div>${safeLabel}</div><div class="ui gray label">${safeFullName}</div>`;
      }

      function renderDetails(data, type, row, meta) {
        if (data === null || data === undefined) {
          return "";
        }
        if (typeof data === "object" && data !== null) {
          if (type === "display") {
            let msg = "";
            if ("message" in data) {
              msg +=
                "<div>" +
                data.message.replace(/\$\{(\w+)\}/g, (m, p1) =>
                  data[p1] !== undefined ?
                    `<div class="ui blue horizontal label">${data[p1]}</div>`
                  : m
                ) +
                "</div>";
            }
            if ("elements" in data) {
              msg += `<div style="margin-top:0.5em;display:flex;flex-wrap:wrap;gap:0.5em;">${data.elements.map((e) => renderElement(e, type, "teal")).join("")}</div>`;
            }
            if ("element" in data) {
              msg += `<div style="margin-top:0.5em;display:flex;flex-wrap:wrap;gap:0.5em;">${renderElement(data.element, type, "teal")}`;
              if ("related" in data) {
                msg += `<span>: </span>${data.related.map((e) => renderElement(e, type, "yellow")).join("")}`;
              }
              msg += "</div>";
            }
            return msg;
          } else {
            let msg = "";
            if ("message" in data) {
              msg += data.message.replace(/\$\{(\w+)\}/g, (m, p1) =>
                data[p1] !== undefined ? data[p1] : m
              );
            }
            if ("elements" in data) {
              msg += `${msg ? "; " : ""}elements=(${data.elements.map((e) => renderElement(e, type)).join(", ")})`;
            }
            if ("element" in data) {
              msg += `${msg ? "; " : ""}${renderElement(data.element, type, "teal")}`;
              if ("related" in data) {
                msg += `: ${data.related.map((e) => renderElement(e, type, "yellow")).join(", ")}`;
              }
            }
            return msg;
          }
        }
        return data;
      }

      function renderElement(data, type, colour) {
        if (data === null || data === undefined) {
          return "";
        }
        if (type === "display") {
          return `<div class="ui ${colour} horizontal label">${data.name}<div class="detail">${data.type}</div></div>`;
        } else {
          return `<div>${data.name}[${data.type}]</div>`;
        }
      }

      function renderSeverityLabel(data, type, row, meta) {
        if (!data) {
          return null;
        }

        if (type !== "display") {
          return data;
        }

        const color =
          data === "error" ? "red"
          : data === "warning" ? "yellow"
          : "teal";
        return `<div class="ui ${color} label">${data}</div>`;
      }

      // Generate matrix data
      function generateViolationMatrix() {
        // Create a map of flow names to their type and status from flowData
        const flowInfoMap = {};
        flowData.forEach((flow) => {
          flowInfoMap[flow.name.fullName] = {
            type: flow.type,
            status: flow.status,
          };
        });

        // Get unique violation types and flow types
        const violationTypes = [
          ...new Set(flowBestPracticeData.map((v) => v.rule)),
        ].sort();
        const flowTypes = [...new Set(flowData.map((f) => f.type))].sort();

        // Get severity for each violation type
        const violationSeverity = {};
        flowBestPracticeData.forEach((v) => {
          if (!violationSeverity[v.rule]) {
            violationSeverity[v.rule] = v.severity;
          }
        });

        // Generate matrix data for all flows
        const matrixDataAll = violationTypes.map((violationType) => {
          const row = { violationType };

          flowTypes.forEach((flowType) => {
            const flowsOfType = flowData.filter((f) => f.type === flowType);
            const flowsWithViolation = new Set();

            flowBestPracticeData.forEach((violation) => {
              if (violation.rule === violationType) {
                const flowInfo = flowInfoMap[violation.flow.fullName];
                if (flowInfo && flowInfo.type === flowType) {
                  flowsWithViolation.add(violation.flow.fullName);
                }
              }
            });

            row[flowType] = {
              violations: flowsWithViolation.size,
              total: flowsOfType.length,
              hasViolations: flowsWithViolation.size > 0,
            };
          });

          return row;
        });

        // Generate matrix data for active flows only
        const matrixDataActive = violationTypes.map((violationType) => {
          const row = { violationType };

          flowTypes.forEach((flowType) => {
            const activeFlowsOfType = flowData.filter(
              (f) => f.type === flowType && f.status === "Active"
            );
            const activeFlowsWithViolation = new Set();

            flowBestPracticeData.forEach((violation) => {
              if (violation.rule === violationType) {
                const flowInfo = flowInfoMap[violation.flow.fullName];
                if (
                  flowInfo &&
                  flowInfo.type === flowType &&
                  flowInfo.status === "Active"
                ) {
                  activeFlowsWithViolation.add(violation.flow.fullName);
                }
              }
            });

            row[flowType] = {
              violations: activeFlowsWithViolation.size,
              total: activeFlowsOfType.length,
              hasViolations: activeFlowsWithViolation.size > 0,
            };
          });

          return row;
        });

        return {
          matrixDataAll,
          matrixDataActive,
          flowTypes,
          violationSeverity,
        };
      }

      // Generate color based on violation percentage
      function getViolationColor(violations, total) {
        if (total === 0) return "#f8f9fa"; // Light gray for no flows
        const percentage = (violations / total) * 100;

        if (percentage === 0) return "#dce9e2"; // Light green
        if (percentage <= 25) return "#c7e4d3"; // Green
        if (percentage <= 50) return "#fff3cd"; // Yellow
        if (percentage <= 75) return "#f4c2c7"; // Light red
        return "#efb3b8"; // Red
      }

      // Generate severity label HTML
      function getSeverityLabel(severity) {
        const color =
          severity === "error" ? "red"
          : severity === "warning" ? "yellow"
          : "teal";
        return `<div class="ui ${color} label">${severity}</div>`;
      }

      // Generate matrix table HTML
      function generateMatrixTable(data, flowTypes, violationSeverity, title) {
        let html = `<table class="ui celled collapsing table matrix-table" style="table-layout: auto;">
          <thead>
            <tr>
              <th>Violation Type</th>`;

        // Modified header cells with rotated text
        flowTypes.forEach((flowType) => {
          html += `
            <th class="flow-type" style="width: 90px">
                <div>${flowType}</div>
            </th>`;
        });

        html += `
            </tr>
          </thead>
          <tbody>`;

        // Add data rows
        data.forEach((row) => {
          const severity = violationSeverity[row.violationType];
          html += `
            <tr>
              <td style="text-align: left;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span>${row.violationType}</span>
                  ${getSeverityLabel(severity)}
                </div>
              </td>`;

          flowTypes.forEach((flowType) => {
            const cellData = row[flowType];
            const backgroundColor = getViolationColor(
              cellData.violations,
              cellData.total
            );
            const text =
              cellData.total > 0 ?
                `${cellData.violations} / ${cellData.total}`
              : "0 / 0";
            const fontWeight = cellData.violations > 0 ? "bold" : "normal";
            const color = cellData.violations === 0 ? "#999" : "inherit";

            html += `<td style="text-align: center; background-color: ${backgroundColor}; font-weight: ${fontWeight}; color: ${color};">${text}</td>`;
          });

          html += `</tr>`;
        });

        html += `
          </tbody>
        </table>`;

        return html;
      }

      $(document).ready(function () {
        // Generate matrix data
        const matrixData = generateViolationMatrix();

        // Generate and insert the matrix tables
        const allFlowsTable = generateMatrixTable(
          matrixData.matrixDataAll,
          matrixData.flowTypes,
          matrixData.violationSeverity,
          "All Flows"
        );
        document.getElementById("violation-matrix-all-container").innerHTML =
          allFlowsTable;

        const activeFlowsTable = generateMatrixTable(
          matrixData.matrixDataActive,
          matrixData.flowTypes,
          matrixData.violationSeverity,
          "Active Flows"
        );
        document.getElementById("violation-matrix-active-container").innerHTML =
          activeFlowsTable;

        // Initialize detailed violations table
        initDataTableWithButtons(
          "#best-practices",
          "Flow Best Practices",
          true,
          true,
          {
            data: flowBestPracticeData,
            columns: [
              { data: "flow", title: "Flow", render: renderLabelAndFullName },
              { data: "rule", title: "Violated Rule" },
              { data: "details", title: "Details", render: renderDetails },
              {
                data: "severity",
                title: "Severity",
                render: renderSeverityLabel,
              },
            ],
            pageLength: 20,
            lengthMenu: [20, 40, 70, 100],
          }
        );
      });
    </script>
  </body>
</html>
